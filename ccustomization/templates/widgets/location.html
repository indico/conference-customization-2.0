{% extends 'widgets/_widget.html' %}

{% block widget_style -%}
    {% if settings.empty %}
        background: url('http://upload.wikimedia.org/wikipedia/commons/f/f7/Soho_-_map_1.png') no-repeat center;
        background-size: 100%;
    {% endif %}
{%- endblock %}

{% block widget_content %}

    <script>
        function geoCode(mapCanvas, address) {
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    drawMap(mapCanvas, results[0].geometry.location);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function drawMap(mapCanvas, coords) {
            var options = {
                zoom: 9,
                center: coords,
                mapTypeControl: false,
                navigationControlOptions: {
                    style: google.maps.NavigationControlStyle.SMALL
                },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(mapCanvas.get(0), options);
            var marker = new google.maps.Marker({
                position: coords,
                map: map
            });
            $('body').on('sortstop', function(){
                google.maps.event.trigger(map, 'resize');
                map.setCenter(coords);
            });
        }
    </script>

    {% if not settings.empty %}
        <div id="map-canvas-{{ counter }}" data-type="{{ settings.content.type }}" {% if settings.content.type == 'address' %}data-address="{{ settings.content.address }}"{% else %}data-latitude="{{ settings.content.latitude }}" data-longitude="{{ settings.content.longitude }}"{% endif %} style="min-height: 400px;{% if edit %} z-index: -1;{% endif %}"></div>

        <script>

            $(document).ready(function() {
                "use strict";

                var mapCanvas = $('#map-canvas-{{ counter }}');

                if (mapCanvas.data('type') == 'address') {
                    geoCode(mapCanvas, mapCanvas.data('address'));
                } else {
                    drawMap(mapCanvas, new google.maps.LatLng(mapCanvas.data('latitude'), mapCanvas.data('longitude')));
                }

            });

        </script>
    {% endif %}

    {% if edit %}

        <div class="modal fade" id="style-dialog-{{ counter }}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Style and content customization</h4>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" role="tablist">
                            <li id="address-opt-{{ counter }}" class="active"><a href="#address-div-{{ counter }}" role="tab" data-toggle="tab">Address</a></li>
                            <li id="coordinates-opt-{{ counter }}"><a href="#coordinates-div-{{ counter }}" role="tab" data-toggle="tab">Coordinates</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade in active container-fluid" id="address-div-{{ counter }}">
                                <div class="row">
                                    <div class="col-md-2">
                                        <label for="address-{{ counter }}">Address</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" name="address-{{ counter }}" id="address-{{ counter }}" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade container-fluid" id="coordinates-div-{{ counter }}">
                                <div class="row">
                                    <div class="col-md-2">
                                        <label for="latitude-{{ counter }}">Latitude</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" name="latitude-{{ counter }}" id="latitude-{{ counter }}" class="form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2">
                                        <label for="longitude-{{ counter }}">Longitude</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" name="longitude-{{ counter }}" id="longitude-{{ counter }}" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary save-button">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <script>

            $(document).ready(function() {
                "use strict";

                var styleDialog = $('#style-dialog-{{ counter }}');
                var save = styleDialog.find('.save-button');
                var widget = styleDialog.parent('.widget-test');
                var settings = widget.data('settings');
                var radio = $('#radio-{{ counter }}');
                var addressOpt = $('#address-opt-{{ counter }}');
                var coordinatesOpt = $('#coordinates-opt-{{ counter }}');
                var addressDiv = $('#address-div-{{ counter }}');
                var coordinatesDiv = $('#coordinates-div-{{ counter }}');
                var address = $('#address-{{ counter }}');
                var latitude = $('#latitude-{{ counter }}');
                var longitude = $('#longitude-{{ counter }}');

                styleDialog.detach().appendTo('body');

                save.on('click', function(){
                    settings['content'] = {}
                    settings['content']['address'] = '';
                    settings['content']['latitude'] = '';
                    settings['content']['longitude'] = '';
                    if (addressOpt.hasClass('active')) {
                        settings['content']['type'] = 'address';
                        settings['content']['address'] = address.val();
                        settings['empty'] = address.val() == '';
                    } else {
                        settings['content']['type'] = 'coordinates';
                        settings['content']['latitude'] = latitude.val();
                        settings['content']['longitude'] = longitude.val();
                        settings['empty'] = latitude.val() == '' || longitude.val() == '';
                    }
                    updateWidget(widget, settings);
                    styleDialog.trigger("hidden.bs.modal");
                });

                styleDialog.on('hidden.bs.modal', function() {
                    styleDialog.modal('hide');
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                });

                $('ul.nav-tabs li a').on('click', function(e){
                    e.preventDefault();
                    $(this).tab('show');
                });

                styleDialog.modal({
                    show: false
                });

                widget.on('click', function(){
                    $('.widget-test').removeClass('selected');
                    widget.addClass('selected');
                    if (settings['content'] != undefined) {
                        if (settings['content']['type'] == 'address' || settings['content']['type'] == undefined) {
                            addressOpt.children('a').trigger('click');
                        } else {
                            coordinatesOpt.children('a').trigger('click');
                        }
                    }
                    if (addressOpt.hasClass('active')) {
                        latitude.val('');
                        longitude.val('');
                        if (settings['content'] != undefined) {
                            address.val(settings['content']['address'] || '');
                        } else {
                            address.val('');
                        }
                    } else {
                        address.val('');
                        if (settings['content'] != undefined) {
                            latitude.val(settings['content']['latitude'] || '');
                            longitude.val(settings['content']['longitude'] || '');
                        } else {
                            latitude.val('');
                            longitude.val('');
                        }
                    }
                    styleDialog.modal('show');
                });

            });

        </script>
    {% endif %}

{% endblock %}
